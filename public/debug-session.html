<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Session Debug Tool</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 40px auto;
        padding: 20px;
      }
      .container {
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
      }
      h1 {
        color: #333;
      }
      .test-section {
        background: white;
        border: 1px solid #ddd;
        padding: 15px;
        margin: 15px 0;
        border-radius: 5px;
      }
      .test-section h2 {
        margin-top: 0;
        color: #ff8a3d;
      }
      button {
        background: #ff8a3d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px 5px 5px 0;
      }
      button:hover {
        background: #ff6b3d;
      }
      .result {
        background: #f9f9f9;
        border-left: 3px solid #ff8a3d;
        padding: 10px;
        margin-top: 10px;
        border-radius: 3px;
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 400px;
        overflow-y: auto;
      }
      .success {
        border-left-color: #28a745;
        background: #f0fff4;
      }
      .error {
        border-left-color: #dc3545;
        background: #fff5f5;
      }
      .loading {
        color: #999;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ”§ Klinik Brayan Sehat - Session Debug Tool</h1>
      <p>
        Use this tool to test session persistence and identify the root cause of
        "failed to load data" errors.
      </p>

      <!-- Test 1: Check Session Status -->
      <div class="test-section">
        <h2>Test 1: Check Current Session Status</h2>
        <p>
          This will show if you're currently authenticated and what session data
          exists.
        </p>
        <button onclick="testSessionStatus()">Check Session Status</button>
        <div id="result1" class="result" style="display: none"></div>
      </div>

      <!-- Test 2: Create Test Session -->
      <div class="test-section">
        <h2>Test 2: Create Test Session Values</h2>
        <p>
          This will create test values in the session to verify persistence
          across requests.
        </p>
        <button onclick="testCreateSession()">Create Test Session</button>
        <div id="result2" class="result" style="display: none"></div>
      </div>

      <!-- Test 3: Verify Persistence -->
      <div class="test-section">
        <h2>Test 3: Verify Session Persistence</h2>
        <p>
          After creating test values above, click this to verify they persisted.
        </p>
        <button onclick="testVerifySession()">Verify Session Persisted</button>
        <div id="result3" class="result" style="display: none"></div>
      </div>

      <!-- Test 4: Full Flow -->
      <div class="test-section">
        <h2>Test 4: Full Flow (Create â†’ Verify)</h2>
        <p>
          Run create and verify in sequence to fully test session persistence.
        </p>
        <button onclick="testFullFlow()">Run Full Session Test</button>
        <div id="result4" class="result" style="display: none"></div>
      </div>

      <!-- Header Inspector -->
      <div class="test-section">
        <h2>Test 5: Inspect Request Headers</h2>
        <p>This will show what headers your browser is sending.</p>
        <button onclick="inspectHeaders()">Inspect Headers</button>
        <div id="result5" class="result" style="display: none"></div>
      </div>

      <!-- Recommendations -->
      <div
        class="test-section"
        style="background: #fffbea; border-left-color: #ffc107"
      >
        <h2>ðŸ“‹ What to Look For</h2>
        <ul>
          <li>
            <strong>Test 1 Result:</strong> Should show
            <code>session_has_admin_id: true</code> if logged in
          </li>
          <li>
            <strong>Test 2 Result:</strong> Should return successfully with
            session_id
          </li>
          <li>
            <strong>Test 3 Result:</strong> Should show test values you just
            created (proves persistence)
          </li>
          <li>
            <strong>Test 5 Result:</strong> Should show
            <code>cookie</code> header contains <code>ci_session=...</code>
          </li>
        </ul>
        <p>
          <strong>If Test 3 shows empty values:</strong> Session is not
          persisting across requests - this is your bug!
        </p>
      </div>
    </div>

    <script>
      const API_PREFIX = "http://localhost:8080/api/admin/debug";

      async function makeRequest(endpoint, method = "GET", body = null) {
        try {
          const options = {
            method: method,
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include", // IMPORTANT: Include cookies
          };

          if (body) {
            options.body = JSON.stringify(body);
          }

          const response = await fetch(`${API_PREFIX}/${endpoint}`, options);
          const data = await response.json();

          return data;
        } catch (error) {
          return { error: error.message };
        }
      }

      function displayResult(elementId, data, isError = false) {
        const elem = document.getElementById(elementId);
        elem.textContent = JSON.stringify(data, null, 2);
        elem.style.display = "block";
        elem.className = "result" + (isError ? " error" : " success");
      }

      async function testSessionStatus() {
        const result1 = document.getElementById("result1");
        result1.textContent = "â³ Loading...";
        result1.style.display = "block";
        result1.className = "result loading";

        const data = await makeRequest("session-status");
        displayResult("result1", data, data.error !== undefined);
      }

      async function testCreateSession() {
        const result2 = document.getElementById("result2");
        result2.textContent = "â³ Loading...";
        result2.style.display = "block";
        result2.className = "result loading";

        const data = await makeRequest("test-session", "POST");
        displayResult("result2", data, data.error !== undefined);
      }

      async function testVerifySession() {
        const result3 = document.getElementById("result3");
        result3.textContent = "â³ Loading...";
        result3.style.display = "block";
        result3.className = "result loading";

        const data = await makeRequest("verify-session");

        // Check if values persisted
        const hasBug = !data.has_test_values && !data.error;
        displayResult("result3", data, data.error !== undefined);

        if (hasBug) {
          const resultElem = document.getElementById("result3");
          resultElem.innerHTML +=
            "\n\nâš ï¸ WARNING: Test values did not persist! Your session is not persisting across requests.";
        }
      }

      async function testFullFlow() {
        const result4 = document.getElementById("result4");
        result4.textContent = "â³ Step 1: Creating session values...";
        result4.style.display = "block";
        result4.className = "result loading";

        const createData = await makeRequest("test-session", "POST");
        result4.textContent =
          "âœ“ Step 1 Complete\n\n" + JSON.stringify(createData, null, 2);
        result4.textContent +=
          "\n\nâ³ Step 2: Verifying persistence (waiting 1 second)...";

        // Wait 1 second
        await new Promise((resolve) => setTimeout(resolve, 1000));

        const verifyData = await makeRequest("verify-session");
        result4.textContent +=
          "\n\nâœ“ Step 2 Complete\n\n" + JSON.stringify(verifyData, null, 2);

        // Final verdict
        if (verifyData.has_test_values) {
          result4.className = "result success";
          result4.textContent +=
            "\n\nâœ… SUCCESS: Session is persisting correctly!";
        } else {
          result4.className = "result error";
          result4.textContent +=
            "\n\nâŒ FAILED: Session did not persist. This is the root cause of your issues.";
        }
      }

      async function inspectHeaders() {
        const result5 = document.getElementById("result5");
        result5.textContent = "â³ Loading...";
        result5.style.display = "block";
        result5.className = "result loading";

        const data = await makeRequest("session-status");

        // Extract headers portion
        if (data.headers) {
          result5.textContent = JSON.stringify(data.headers, null, 2);
          result5.className = "result success";

          if (data.headers.cookie) {
            result5.textContent += "\n\nâœ“ Cookie header found!";
          } else {
            result5.textContent +=
              "\n\nâš ï¸ WARNING: No cookie header sent! This means credentials are not being included in the request.";
          }
        }
      }

      // Auto-test on load
      window.addEventListener("load", () => {
        console.log("Session Debug Tool loaded. Run tests manually.");
      });
    </script>
  </body>
</html>
